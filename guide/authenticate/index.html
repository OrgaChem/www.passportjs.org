<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Passport  | 認証 </title>    <link rel="stylesheet" href="/www.passportjs.org/vendor/bootstrap/2.2.1/css/bootstrap.css">
    <link rel="stylesheet" href="/www.passportjs.org/vendor/highlight/gc5f3dbd/styles/github.css">
    <link rel="stylesheet" href="/www.passportjs.org/assets/css/site.css">
  </head>
  <body>
    <div class="container">
      <div class="masthead">
  <ul class="nav nav-pills pull-right">
    <li><a href="./">ホーム</a></li>    <li class="active"><a href="guide/">使い方</a></li>  </ul>
  <h3><a href="/www.passportjs.org/"><img src="/www.passportjs.org/assets/images/logo-90px.png" class="logo"> Passport</a></h3>
</div>

      
<div class="row guide">
  <div class="span3 toc">
    <ul class="unstyled">
  <li><a href="/www.passportjs.org/guide/">はじめに</a></li>
  <li><a href="/www.passportjs.org/guide/authenticate/">認証</a></li>
  <li><a href="/www.passportjs.org/guide/configure/">設定方法</a></li>
  <li><a href="/www.passportjs.org/guide/username-password/">ユーザー名 &amp; パスワード</a></li>
  <li><a href="/www.passportjs.org/guide/openid/">OpenID</a></li>
  <li><a href="/www.passportjs.org/guide/oauth/">OAuth</a></li>
  <li><strong>対応しているサービス</strong></li>
  <ul>
    <li><a href="/www.passportjs.org/guide/facebook/">Facebook</a></li>
    <li><a href="/www.passportjs.org/guide/twitter/">Twitter</a></li>
    <li><a href="/www.passportjs.org/guide/google/">Google</a></li>
    <li><a href="/www.passportjs.org/guide/providers/">その他</a></li>
  </ul>
  <li><strong>認証スキーム</strong></li>
  <ul>
    <li><a href="/www.passportjs.org/guide/basic-digest/">Basic認証 &amp; Digest認証</a></li>
    <li><a href="/www.passportjs.org/guide/oauth-api/">OAuth</a></li>
    <li><a href="/www.passportjs.org/guide/oauth2-api/">OAuth 2.0</a></li>
    <li><a href="/www.passportjs.org/guide/other-api/">その他</a></li>
  </ul>
  <li><strong>操作</strong></li>
  <ul>
    <li><a href="/www.passportjs.org/guide/login/">ログイン</a></li>
    <li><a href="/www.passportjs.org/guide/logout/">ログアウト</a></li>
    <li><a href="/www.passportjs.org/guide/authorize/">権限付与</a></li>
  </ul>
  <li><a href="/www.passportjs.org/guide/profile/">ユーザープロフィール</a></li>
</ul>

  </div>
  <div class="span9 content">
    <h3 id="-">認証</h3>
<p>認証リクエストは <code>passport.authenticate()</code> に使いたい認証ストラテジーを指定して呼び出すだけで実行できます。
<code>authenticate()</code>によって返される関数は <a href="http://www.senchalabs.org/connect/">Connect</a> 標準に準拠しているので、<a href="http://expressjs.com/">Express</a> アプリケーションのルーティングミドルウェアとして簡単に利用できます。</p>
<blockquote class="original">
Authenticating requests is as simple as calling <code>passport.authenticate()</code> and
specifying which strategy to employ.  <code>authenticate()</code>&#39;s function signature is
standard <a href="http://www.senchalabs.org/connect/">Connect</a> middleware, which makes it
convenient to use as route middleware in <a href="http://expressjs.com/">Express</a>
applications.
</blockquote>

<pre><code class="undefinedjavascript">app.post(<span class="string">'/login'</span>,
  passport.authenticate(<span class="string">'local'</span>),
  <span class="function"><span class="keyword">function</span><span class="params">(req, res)</span> {</span>
    <span class="comment">// 認証に施工すると、この関数が呼び出される。</span>
    <span class="comment">// 認証されたユーザーは `req.user` に含まれている。</span>
    res.redirect(<span class="string">'/users/'</span> + req.user.username);
  });</code></pre>
<p>Passport は、認証に失敗したとき <code>401 Unauthorized</code> ステータスを返し、その他のルーティングハンドラーは実行しません。
認証に成功したときは、次のハンドラーを実行し、<code>req.user</code> プロパティに認証されたユーザーをセットします。</p>
<blockquote class="original">
By default, if authentication fails, Passport will respond with a
<code>401 Unauthorized</code> status, and any additional route handlers will not be
invoked.  If authentication succeeds, the next handler will be invoked and the
<code>req.user</code> property will be set to the authenticated user.
</blockquote>

<p><small>注意: ストラテジーはルーティングされる前に設定されていなければなりません。
詳細は<a href="/www.passportjs.org/guide/configure/">設定</a>の章で確認できます。</small></p>
<blockquote class="original">
Note: Strategies must be configured prior to using them in a route.  Continue
reading the chapter on <a href="/guide/configure/">configuration</a> for details.
</blockquote>

<h4 id="-">リダイレクト</h4>
<p>リダイレクトは、一般的にリクエストの認証後におこなわれます。</p>
<blockquote class="original">
A redirect is commonly issued after authenticating a request.
</blockquote>

<pre><code class="undefinedjavascript">app.post(<span class="string">'/login'</span>,
  passport.authenticate(<span class="string">'local'</span>, { successRedirect: <span class="string">'/'</span>,
                                   failureRedirect: <span class="string">'/login'</span> }));</code></pre>
<p>この例では、リダイレクトオプションはデフォルトの振る舞いをオーバーライドしています。
認証が成功するとユーザーはホームページにリダイレクトされ、認証が失敗するとユーザーはもう一度認証をおこなうためにログインページに戻るようリダイレクトされます。</p>
<blockquote class="original">
In this case, the redirect options override the default behavior.  Upon
successful authentication, the user will be redirected to the home page.  If
authentication fails, the user will be redirected back to the login page for
another attempt.
</blockquote>

<h4 id="-">フラッシュメッセージ</h4>
<p>リダイレクトの後で、ステータス情報を表示するためのフラッシュメッセージを表示することがよくあります。</p>
<blockquote class="original">
Redirects are often combined with flash messages in order to display status
information to the user.
</blockquote>

<pre><code class="undefinedjavascript">app.post(<span class="string">'/login'</span>,
  passport.authenticate(<span class="string">'local'</span>, { successRedirect: <span class="string">'/'</span>,
                                   failureRedirect: <span class="string">'/login'</span>,
                                   failureFlash: <span class="literal">true</span> })
);</code></pre>
<p><code>failureFlash</code> オプションを <code>true</code> にセットすると、Passport はストラテジーの検証用のコールバックが生成したメッセージを <code>error</code> メッセージとして表示します。
この方法を使うと、検証用のコールバックは認証が失敗した理由について正確に判断することができます。
これは多くの場合にもっとも優れたアプローチです。</p>
<blockquote class="original">
Setting the <code>failureFlash</code> option to <code>true</code> instructs Passport to flash an
<code>error</code> message using the message given by the strategy&#39;s verify callback, if
any.  This is often the best approach, because the verify callback can make the
most accurate determination of why authentication failed.
</blockquote>

<p>あるいは、フラッシュメッセージを任意に指定することもできます。</p>
<blockquote class="original">
Alternatively, the flash message can be set specifically.
</blockquote>

<pre><code class="undefinedjavascript">passport.authenticate(<span class="string">'local'</span>, { failureFlash: <span class="string">'ユーザーIDかパスワードが間違っています。'</span> });</code></pre>
<p>また、認証成功時の <code>success</code> メッセージは <code>successFlash</code> オプションによって指定できます。</p>
<blockquote class="original">
A <code>successFlash</code> option is available which flashes a <code>success</code> message when
authentication succeeds.
</blockquote>

<pre><code class="undefinedjavascript">passport.authenticate(<span class="string">'local'</span>, { successFlash: <span class="string">'ようこそ！'</span> });</code></pre>
<p><small>注意: フラッシュメッセージを使うためには、<code>req.flash()</code> 関数が必要です。
この関数はExpress 2.x までは提供されていましたが、Express 3.x からは取り除かれています。
Express 3.x では、<a href="https://github.com/jaredhanson/connect-flash">connect-flash</a> ミドルウェアを使うことでこの機能を利用することができます。</small></p>
<blockquote class="original">
Note: Using flash messages requires a <code>req.flash()</code> function.  Express 2.x
provided this functionality, however it was removed from Express 3.x.  Use of
<a href="https://github.com/jaredhanson/connect-flash">connect-flash</a> middleware is
recommended to provide this functionality when using Express 3.x.
</blockquote>

<h4 id="-">セッションを無効化</h4>
<p>認証が成功した際、Passport は継続的なログインセッションを確立します。
これはユーザーがブラウザから Web アプリケーションにアクセスするといったシナリオで役に立ちます。
しかし、それ以外の場合はセッションのサポートは必要ありません。
たとえば、API サーバーはリクエスト毎に認証情報を要求するのが一般的です。
このような場合では <code>seeeion</code> オプションを <code>false</code> にすることでセッションサポートを無効にできます。</p>
<blockquote class="original">
After successful authentication, Passport will establish a persistent login
session.  This is useful for the common scenario of users accessing a web
application via a browser.  However, in some cases, session support is not
necessary.  For example, API servers typically require credentials to be
supplied with each request.  When this is the case, session support can be
safely disabled by setting the <code>session</code> option to <code>false</code>.
</blockquote>

<pre><code class="undefinedjavascript">app.get(<span class="string">'/api/users/me'</span>,
  passport.authenticate(<span class="string">'basic'</span>, { session: <span class="literal">false</span> }),
  <span class="function"><span class="keyword">function</span><span class="params">(req, res)</span> {</span>
    res.json({ id: req.user.id, username: req.user.username });
  });</code></pre>
<h4 id="-">カスタムコールバック</h4>
<p>ビルトインオプションが認証リクエストを処理するのに十分でない場合は、カスタムコールバックによって成功・失敗を処理できます。</p>
<blockquote class="original">
If the built-in options are not sufficient for handling an authentication
request, a custom callback can be provided to allow the application to handle
success or failure.
</blockquote>

<pre><code class="undefinedjavascript">app.get(<span class="string">'/login'</span>, <span class="function"><span class="keyword">function</span><span class="params">(req, res, next)</span> {</span>
  passport.authenticate(<span class="string">'local'</span>, <span class="function"><span class="keyword">function</span><span class="params">(err, user, info)</span> {</span>
    <span class="keyword">if</span> (err) { <span class="keyword">return</span> next(err); }
    <span class="keyword">if</span> (!user) { <span class="keyword">return</span> res.redirect(<span class="string">'/login'</span>); }
    req.logIn(user, <span class="function"><span class="keyword">function</span><span class="params">(err)</span> {</span>
      <span class="keyword">if</span> (err) { <span class="keyword">return</span> next(err); }
      <span class="keyword">return</span> res.redirect(<span class="string">'/users/'</span> + user.username);
    });
  })(req, res, next);
});</code></pre>
<p>この例では、<code>authenticate()</code> はルーティングミドルウェアで使われずにルーティングハンドラーから呼ばれています。
こうすることで、コールバックのクロージャ内で <code>req</code> と <code>res</code> オブジェクトにアクセスできています。</p>
<blockquote class="original">
In this example, note that <code>authenticate()</code> is called from within the route
handler, rather than being used as route middleware.  This gives the callback
access to the <code>req</code> and <code>res</code> objects through closure.
</blockquote>

<p>もし認証が失敗したときは、 <code>user</code> は <code>false</code> にセットされます。
例外が発生したときは <code>err</code> がセットされます。また、ストラテジーの検証用コールバックに追加で情報を渡すときには <code>into</code> パラメータを利用できます（省略可能）。</p>
<blockquote class="original">
If authentication failed, <code>user</code> will be set to <code>false</code>.  If an exception
occurred, <code>err</code> will be set.  An optional <code>info</code> argument will be passed,
containing additional details provided by the strategy&#39;s verify callback.
</blockquote>

<p>このコールバックには必要な認証結果が引数として渡されます。
ただし、カスタムコールバックを使うときは、アプリケーションセッション確立（<code>req.login()</code>を呼び出すことによる）およびレスポンスの送信をおこなう必要があります。</p>
<blockquote class="original">
The callback can use the arguments supplied to handle the authentication result
as desired.  Note that when using a custom callback, it becomes the
application&#39;s responsibility to establish a session (by calling <code>req.login()</code>)
and send a response.
</blockquote>
  </div>
</div>
      <div class="footer">
  <p>&copy; 2011-2013 Jared Hanson<br/><a href="https://github.com/stuartpb/passport-logo">Logo</a> by <a href="https://github.com/stuartpb">Stuart P. Bentley</a>, <a href="http://creativecommons.org/licenses/by-sa/3.0/">CC BY-SA 3.0</a><br>Translation by <a href="https://github.com/OrgaChem">OrgaChem</a>, <a href="https://github.com/e-mon">e-mon</p>
</div>

    </div>
    <script src="/www.passportjs.org/vendor/jquery/1.11.0/jquery.min.js"></script>
    <script src="/www.passportjs.org/assets/js/showorigin.js"></script>
  </body>
</html>
